---
description: "Memo_v2 graph I/O contract: executorArgs vs resolverResults, HITL routing, adapters."
globs:
  - "Memo_v2/src/graph/**/*.ts"
  - "Memo_v2/src/services/adapters/**/*.ts"
  - "Memo_v2/src/services/resolution/**/*.ts"
alwaysApply: false
---

## State contract (single source of truth)

- Runtime state is defined in `Memo_v2/src/graph/state/MemoState.ts`.
- Shared I/O types are in `Memo_v2/src/types/index.ts`.
- If you add a field to state or change a type, update:
  - `Memo_v2/docs/STATE_SCHEMA.md`
  - `Memo_v2/docs/SYSTEM_DIAGRAM.md` (if flow changed)

## Resolver → entity resolution → executor contract

- Resolvers produce **semantic args** into `state.resolverResults`.
- `EntityResolutionNode` is responsible for producing **ID-resolved args** into `state.executorArgs`.
- `ExecutorNode` must prefer `executorArgs` over `resolverResults` when both exist.

## HITL contract (canonical control-plane)

- Single contract: **one `pendingHITL` at a time** in state.
- `interrupt()` is called only by `HITLGateNode`.
- Resume routing is deterministic via `Command({ update, goto })` derived from `pendingHITL.returnTo`.
- All HITL results stored in `state.hitlResults[hitlId]`.
- Canonical types in `Memo_v2/src/types/hitl.ts`.
- Disambiguation HITL flow:
  - Entity resolver returns `type:'disambiguation'` (machine-only, no user-facing text)
  - `EntityResolutionNode` sets `state.disambiguation` (candidates + metadata)
  - `entityResolutionRouter` routes to `hitl_gate`
  - `HITLGateNode` creates `pendingHITL` with `kind:'disambiguation'`, interrupts
  - On resume: `HITLGateNode` validates, writes `hitlResults`, `Command({ goto: 'entity_resolution' })`
  - `EntityResolutionNode` reads selection from `hitlResults` + `disambiguation.userSelection`, calls `applySelection()`
- Planner HITL flow:
  - `HITLGateNode` checks planner conditions (confidence, missingFields, risk, approval)
  - Creates `pendingHITL` with `kind:'clarification'|'approval'`, interrupts
  - On resume: routes to `planner` (replan) or `resolver_router` (continue)
- Executor idempotency: `operationId = traceId + ':' + stepId` checked in `executedOperations` ledger.

See: `Memo_v2/docs/PLANNER_AND_HITL_FLOW.md`.

